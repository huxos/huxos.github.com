<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>kubernetes集群搭建（5. kube-dns、dashboard）</title>
    
    <meta name="description" content="kubernetes集群搭建">
    
    <meta name="author" content="Huxos">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="author" href="//huxos.me">
    <link href="http://localhost:4000/kubernetes/2017/09/19/kubernetes-cluster-05-kube-addons.html" rel="canonical">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="alternate" type="application/rss+xml" title="Huxos" href="http://localhost:4000/feed.xml">
    <link rel="stylesheet" href="//cdn.staticfile.org/fluidbox/1.3.1/jquery.fluidbox.css">
    <link type="text/css" rel="stylesheet" href="/assets/application.css">
    <script src="//libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
    <script src="//cdn.staticfile.org/fluidbox/1.3.1/jquery.fluidbox.min.js"></script>
    <script async="" src="//www.google-analytics.com/analytics.js"></script>
  </head>

  <body>
  <header class="site-header" role="banner">
      <div class="container">
        <a href="/" class="logo"><img src="/assets/logo.png" alt="Huxos" class="site-logo"></a>
        <nav role="navigiation">
          <ul class="site-nav">
            <li><a href="/about/">About</a>
            <li><a href="/blog/">Blog</a>
          </ul>
        </nav>
      </div>
    </header>

    

    <div class="site-content">
      <div class="container">
        <h1 class="post-title">kubernetes集群搭建（5. kube-dns、dashboard）</h1>
<p class="post-meta">19 Sep 2017</p>

<div class="posts">
<blockquote>
  <p>kube-dns、dashboard以deployment的方式部署到kubernetes，运行在kube-system这个namespace中。
只需要导入相应的模版就行，部署较为简单。</p>
</blockquote>

<ol>
  <li>
    <p>下载</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> # wget https://github.com/kubernetes/kubernetes/releases/download/v1.7.4/kubernetes.tar.gz  -O - |tar -zxpvf -
 # cd kubernetes
</code></pre>
    </div>
  </li>
  <li>
    <p>kube-dns</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> ~/kubernetes # cd cluster/addons/dns
 ~/k/c/a/dns # rm -rf *.yaml.sed
 ~/k/c/a/dns # cat  transforms2sed.sed
 s/__PILLAR__DNS__SERVER__/10.99.66.2/g
 s/__PILLAR__DNS__DOMAIN__/cluster.local/g
 s/__MACHINE_GENERATED_WARNING__/Warning: This is a file generated from the base underscore template file: __SOURCE_FILENAME__/g
 ~/k/c/a/dns # make
 sed -f transforms2sed.sed kubedns-controller.yaml.base  | sed s/__SOURCE_FILENAME__/kubedns-controller.yaml.base/g &gt; kubedns-controller.yaml.sed
 sed -f transforms2sed.sed kubedns-svc.yaml.base  | sed s/__SOURCE_FILENAME__/kubedns-svc.yaml.base/g &gt; kubedns-svc.yaml.sed
</code></pre>
    </div>

    <ul>
      <li>进入<code class="highlighter-rouge">cluster/addons/dns</code>目录</li>
      <li>删除<code class="highlighter-rouge">*.yaml.sed</code></li>
      <li>编辑<code class="highlighter-rouge">transforms2sed.sed</code> 将里面的<code class="highlighter-rouge">$DNS_SERVER</code>、<code class="highlighter-rouge">$DNS_DOMAIN</code>替换成相应的地址和集群名字</li>
      <li>然后执行<code class="highlighter-rouge">make</code>指令，就生成了kube-dns的模版</li>
      <li>
        <p>最后导入模版到kubernetes 集群</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>  kubectl create -f  kubedns-cm.yaml -f kubedns-sa.yaml  -f kubedns-controller.yaml.sed -f kubedns-svc.yaml.sed
</code></pre>
        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>dashboard 插件部署</p>

    <p>首先创建server-account</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kube-system
</code></pre>
    </div>

    <p>创建ClusterRoleBonding，分配k8s内置的view角色给它，访问到kube-dashbroad的用户拥有只读的权限。</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
- kind: ServiceAccount
  name: kubernetes-dashboard
  namespace: kube-system
</code></pre>
    </div>

    <p>进入<code class="highlighter-rouge">cluster/addons/dashboard</code> 编辑 <code class="highlighter-rouge">dashboard-controller.yaml</code> 加入<code class="highlighter-rouge">serviceAccount: kubernetes-dashboard</code>。</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>....
        livenessProbe:
          httpGet:
            path: /
            port: 9090
          initialDelaySeconds: 30
          timeoutSeconds: 30
      serviceAccount: kubernetes-dashboard #添加sa
      tolerations:
      - key: "CriticalAddonsOnly"
        operator: "Exists"
....
</code></pre>
    </div>

    <p>最后执行</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>kubectl create -f dashboard-controller.yaml dashboard-service.yaml
</code></pre>
    </div>
  </li>
</ol>

<p>至此kube-dns、dashboard就部署完成了。</p>

</div>

<div class="post-comments">
    <a href="javascript:;" onclick='share_to_weibo()'>
        <i class="icon-weibo"></i>分享到微博</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  指正、疑问、评论可通过<a href="http://weibo.com/weihy511" rel="nofollow">Weibo(@PACMAN_)</a>联系我。
</div>

<script>
    function share_to_weibo(){
      location.href="http://service.weibo.com/share/share.php?title="+encodeURIComponent('kubernetes集群搭建（5. kube-dns、dashboard） —— http://huxos.me')+"&url="+encodeURIComponent(location.href);
    }
</script>

      </div>
    </div>

    <footer class="site-footer">
      <div class="container">
        © Huxos 2014.
        <br>
        liberty, when it begins to take root, it a plant of rapid growth.
        <br>
        Powered By Jekyll on Github, Forked from <a href="https://github.com/RichGuk/richguk.github.io">RichGuk</a>.
      </div>
    </footer>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-36713694-1', 'huxos.me');
      ga('send', 'pageview');
      $(function() {
        $('a[data-fluidbox]').fluidbox();
      });
    </script>
  </body>
</html>
